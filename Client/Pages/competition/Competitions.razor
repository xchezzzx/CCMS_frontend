@page "/competitions"
@attribute [Authorize(Roles = ("[\"Administrator\"], [\"Operator\"]"))]

@inject ICompetitionService CompetitionService



<PageTitle>Competition page</PageTitle>

<div class="row d-flex align-items-center">

	<div class="col-8 text-center">
		<h1>Competitions</h1>
	</div>

	<div class="col-4 text-end">

		<button class="btn btn-secondary" @onclick="Toggle">
			<span class="oi oi-grid-three-up"></span>
			<span>&nbsp;@ToggleCaption</span>
		</button>

		<button class="btn btn-success" @onclick="fetchData">
			<span class="oi oi-loop-circular" aria-hidden="true"></span>
			<span>&nbsp;Refresh List</span>
		</button>

		<a class="btn btn-primary"
		   href="/competitions/add"
		   role="button">
			<span class="oi oi-plus" aria-hidden="true"></span>
			<span>&nbsp;Add competiton</span>
		</a>
	</div>

</div>



@if (!dataFetched)
{
	<Loader />
}
else
{
	if (competitions.Count == 0)
	{
		<EmptyList />
	}
	else
	{
		if (_isTable)
		{
			<div class="table-responsive">
				<table class="table table-striped text-center table-hover">
					<thead class="table-light">
						<tr>
							<th>ID</th>
							<th>Name</th>
							<th>Date of competition</th>
							<th>Start Time</th>
							<th>End Time</th>
							<th>Duration</th>
							<th>Concurrent Tasks</th>
							<th>Twitter Hashtag</th>
							<th>State</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var comp in competitions)
						{
							<tr>
								<td>@comp.Id</td>
								<td>@comp.Name</td>
								<td>@comp.StartDateTime.ToLongDateString()</td>
								<td>@comp.StartDateTime.ToString("t")</td>
								<td>@comp.EndDateTime.ToString("t")</td>
								<td>@comp.Duration.ToString("%h") hour(s)</td>
								<td>@comp.NumberConcTasks</td>
								<td>
									<a href="https://twitter.com/search?q=@comp.Hashtag&src=trend_click&vertical=trends" target="_blank">
										#@comp.Hashtag
									</a>
								</td>
								<td>@comp.State</td>
							</tr>
						}

					</tbody>
				</table>
			</div>
		}
		else
		{
			<div class="row row-cols-md-2 g-4">
				@foreach (var comp in competitions)
				{
					<CompetitionCard Competition="@comp" />
				}
			</div>
		}
	}
}


@code {

	private bool _isTable;
	private string ToggleCaption => _isTable ? "Card view" : "Table view";
	string messageFromServer = String.Empty;
	bool dataFetched;

	List<CompetitionDT> competitions = new();

	private void Toggle()
	{
		_isTable = !_isTable;
	}

	protected override async Task OnInitializedAsync()
	{
		dataFetched = false;
		await fetchData();
	}

	public async Task fetchData()
	{
		competitions = await CompetitionService.GetAllActiveCompetitionsAsync();
		dataFetched = true;
	}
}